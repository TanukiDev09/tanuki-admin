{
  "$jsonSchema": {
    "bsonType": "object",
    "additionalProperties": false,
    "required": [
      "date",
      "fiscalYear",
      "flowDirection",
      "amount",
      "currency",
      "movementType",
      "issuerId",
      "issuerName",
      "receiverId",
      "receiverName",
      "paymentChannel",
      "description",
      "notes",
      "allocations",
      "metadata"
    ],
    "properties": {
      "_id": {
        "bsonType": "objectId"
      },
      "date": {
        "bsonType": "date",
        "description": "Fecha contable del movimiento (ISODate)."
      },
      "fiscalYear": {
        "bsonType": [
          "int",
          "long"
        ],
        "minimum": 1900,
        "maximum": 3000,
        "description": "Año fiscal (solo el año). Ej: 2025."
      },
      "flowDirection": {
        "bsonType": "string",
        "enum": [
          "inflow",
          "outflow"
        ],
        "description": "inflow = ingreso, outflow = egreso."
      },
      "amount": {
        "bsonType": "decimal",
        "minimum": 0,
        "description": "Monto total del movimiento (Decimal128)."
      },
      "currency": {
        "bsonType": "string",
        "pattern": "^[A-Z]{3}$",
        "description": "Código ISO 4217 (ej: COP)."
      },
      "movementType": {
        "bsonType": "string",
        "enum": [
          "factura_emitida",
          "factura_recibida",
          "nota_credito",
          "nota_debito",
          "pago_impuestos",
          "servicio",
          "cuenta_de_cobro",
          "transferencia_bancaria",
          "devolucion",
          "ajuste",
          "otro"
        ],
        "description": "Naturaleza del movimiento según práctica contable colombiana."
      },
      "issuerId": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string",
            "minLength": 1
          }
        ],
        "description": "Identificación del emisor (NIT/CC/etc.)."
      },
      "issuerName": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string",
            "minLength": 1
          }
        ],
        "description": "Nombre/razón social del emisor."
      },
      "receiverId": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string",
            "minLength": 1
          }
        ],
        "description": "Identificación del receptor (NIT/CC/etc.)."
      },
      "receiverName": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string",
            "minLength": 1
          }
        ],
        "description": "Nombre/razón social del receptor."
      },
      "issuerIdType": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string",
            "enum": [
              "13",
              "31",
              "other"
            ]
          }
        ],
        "description": "13=persona natural, 31=persona jurídica (convención DIAN/UBL)."
      },
      "receiverIdType": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string",
            "enum": [
              "13",
              "31",
              "other"
            ]
          }
        ],
        "description": "13=persona natural, 31=persona jurídica (convención DIAN/UBL)."
      },
      "paymentChannel": {
        "bsonType": "string",
        "minLength": 1,
        "description": "Canal/medio (texto humano). Ej: Transferencia bancaria."
      },
      "paymentChannelCode": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string"
          }
        ],
        "description": "Código (si aplica, ej: PaymentMeansCode)."
      },
      "paymentRef": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string"
          }
        ],
        "description": "Referencia del pago/transacción/comprobante."
      },
      "invoiceRef": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string"
          }
        ],
        "description": "Ej: Factura X, Cuenta de cobro #, Recibo, etc."
      },
      "description": {
        "bsonType": "string"
      },
      "notes": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "string"
          }
        ]
      },
      "issuedInvoiceAttrs": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "object",
            "additionalProperties": false,
            "properties": {
              "isComplimentary": {
                "bsonType": "bool",
                "description": "True if the issued invoice corresponds to complimentary (free) copies."
              },
              "complimentaryPurpose": {
                "bsonType": "string",
                "enum": [
                  "supporting_copies",
                  "legal_deposit",
                  "pr"
                ],
                "description": "Purpose of complimentary copies (if applicable)."
              }
            }
          }
        ]
      },
      "allocations": {
        "bsonType": "array",
        "minItems": 1,
        "items": {
          "bsonType": "object",
          "additionalProperties": false,
          "required": [
            "costCenter",
            "amount"
          ],
          "properties": {
            "costCenter": {
              "bsonType": "string",
              "enum": [
                "03",
                "01IL002",
                "01IL003",
                "01IL005",
                "01IL006",
                "01T001",
                "01T002",
                "01T003",
                "01T004",
                "01T005",
                "01T006",
                "01T007",
                "01T008",
                "01T009"
              ],
              "description": "Centro de costo (enum editorial)."
            },
            "amount": {
              "bsonType": "decimal",
              "minimum": 0,
              "description": "Monto asignado a este centro de costo."
            },
            "itemId": {
              "anyOf": [
                {
                  "bsonType": "null"
                },
                {
                  "bsonType": "string"
                }
              ],
              "description": "ISBN u otro identificador del ítem."
            },
            "units": {
              "anyOf": [
                {
                  "bsonType": "null"
                },
                {
                  "bsonType": [
                    "int",
                    "long",
                    "double"
                  ]
                }
              ],
              "minimum": 0,
              "description": "Cantidad (unidades) asociadas a este ítem."
            },
            "unitPrice": {
              "anyOf": [
                {
                  "bsonType": "null"
                },
                {
                  "bsonType": "decimal"
                }
              ],
              "minimum": 0,
              "description": "Precio unitario (si aplica)."
            },
            "lineSubtotal": {
              "anyOf": [
                {
                  "bsonType": "null"
                },
                {
                  "bsonType": "decimal"
                }
              ],
              "minimum": 0,
              "description": "Subtotal de la línea (importe de línea)."
            },
            "lineNumber": {
              "anyOf": [
                {
                  "bsonType": "null"
                },
                {
                  "bsonType": "string"
                }
              ],
              "description": "Número/ID de línea (si viene de XML)."
            }
          }
        }
      },
      "emailContactConsent": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "object",
            "additionalProperties": false,
            "required": [
              "inferred"
            ],
            "properties": {
              "inferred": {
                "bsonType": "bool"
              },
              "source": {
                "bsonType": "string",
                "enum": [
                  "orderReference+naturalPerson"
                ],
                "description": "Regla usada para inferir el consentimiento."
              },
              "explicitProof": {
                "bsonType": "object",
                "additionalProperties": false,
                "required": [
                  "docType",
                  "reference"
                ],
                "properties": {
                  "docType": {
                    "bsonType": "string",
                    "enum": [
                      "dian_factura_pdf",
                      "soporte_pago",
                      "recibo",
                      "cuenta_de_cobro_pdf",
                      "otro"
                    ],
                    "description": "Tipo del documento donde consta el consentimiento."
                  },
                  "reference": {
                    "bsonType": "string",
                    "minLength": 1,
                    "description": "Referencia humana del documento (ej: 'FE1682 PDF pág. 1')."
                  },
                  "fileId": {
                    "anyOf": [
                      {
                        "bsonType": "null"
                      },
                      {
                        "bsonType": "string"
                      }
                    ],
                    "description": "ID del archivo en storage (GridFS/S3/etc.) si aplica."
                  },
                  "notedAt": {
                    "anyOf": [
                      {
                        "bsonType": "null"
                      },
                      {
                        "bsonType": "date"
                      }
                    ],
                    "description": "Fecha (ISODate) en la que registraste/confirmaste el consentimiento."
                  }
                }
              },
              "verifiedSample": {
                "anyOf": [
                  {
                    "bsonType": "null"
                  },
                  {
                    "bsonType": "bool"
                  }
                ],
                "description": "Opcional: marcado si fue parte de una muestra verificada."
              }
            },
            "oneOf": [
              {
                "required": [
                  "inferred",
                  "source"
                ],
                "properties": {
                  "inferred": {
                    "enum": [
                      true
                    ]
                  },
                  "source": {
                    "enum": [
                      "orderReference+naturalPerson"
                    ]
                  }
                },
                "not": {
                  "required": [
                    "explicitProof"
                  ]
                }
              },
              {
                "required": [
                  "inferred",
                  "explicitProof"
                ],
                "properties": {
                  "inferred": {
                    "enum": [
                      false
                    ]
                  }
                },
                "not": {
                  "required": [
                    "source"
                  ]
                }
              }
            ]
          }
        ]
      },
      "documents": {
        "anyOf": [
          {
            "bsonType": "null"
          },
          {
            "bsonType": "array",
            "items": {
              "bsonType": "object",
              "additionalProperties": false,
              "required": [
                "docType"
              ],
              "properties": {
                "docType": {
                  "bsonType": "string",
                  "enum": [
                    "dian_factura_xml",
                    "dian_factura_pdf",
                    "soporte_pago",
                    "recibo",
                    "cuenta_de_cobro_pdf",
                    "otro"
                  ]
                },
                "number": {
                  "anyOf": [
                    {
                      "bsonType": "null"
                    },
                    {
                      "bsonType": "string"
                    }
                  ]
                },
                "issueDate": {
                  "anyOf": [
                    {
                      "bsonType": "null"
                    },
                    {
                      "bsonType": "date"
                    }
                  ]
                },
                "uniqueCode": {
                  "anyOf": [
                    {
                      "bsonType": "null"
                    },
                    {
                      "bsonType": "string"
                    }
                  ]
                },
                "orderReferenceId": {
                  "anyOf": [
                    {
                      "bsonType": "null"
                    },
                    {
                      "bsonType": "string"
                    }
                  ]
                },
                "orderReferenceDate": {
                  "anyOf": [
                    {
                      "bsonType": "null"
                    },
                    {
                      "bsonType": "date"
                    }
                  ]
                },
                "fileId": {
                  "anyOf": [
                    {
                      "bsonType": "null"
                    },
                    {
                      "bsonType": "string"
                    }
                  ]
                }
              }
            }
          }
        ]
      },
      "metadata": {
        "bsonType": "object",
        "additionalProperties": false,
        "required": [
          "source",
          "createdAt"
        ],
        "properties": {
          "source": {
            "bsonType": "string",
            "enum": [
              "extracto_bancario_pdf",
              "dian_xml",
              "manual",
              "otro"
            ]
          },
          "createdAt": {
            "bsonType": "date"
          },
          "sourceFile": {
            "anyOf": [
              {
                "bsonType": "null"
              },
              {
                "bsonType": "string"
              }
            ]
          },
          "importBatchId": {
            "anyOf": [
              {
                "bsonType": "null"
              },
              {
                "bsonType": "string"
              }
            ]
          }
        }
      }
    }
  }
}